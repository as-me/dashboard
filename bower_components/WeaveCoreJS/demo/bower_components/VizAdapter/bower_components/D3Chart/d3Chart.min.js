this.d3Chart={},function(){function a(a){this.config=a,this._container=a.container?"#"+a.container:"body",this.interactions=a.interactions,this._columns=a.columns,c=a.margin,this._data=a.data,b=a.size,this._quadTree,this._brush,this._svg,this._kdRect,this._xValue,this._xScale,this._xMap,this._xAxis,this._yValue,this._yScale,this._yMap,this._yAxis,this._cValue,this._point,this._xColumnType,this._yColumnType,this._initializeChart(),this._data&&this.renderChart(this._data)}var b,c,d=a.prototype;d._initializeChart=function(){var a=this;this._xValue=function(a,b){if("string"==typeof a[this._columns.x]){if(isNaN(Number(a[this._columns.x])))return this._xColumnType="string",void 0===a.index?(a.index=b,b):("string"==typeof a.index&&(a.index=Number(a.index)),a.index);this._xColumnType="number",a[this._columns.x]=Number(a[this._columns.x])}return a[this._columns.x]},this._xScale=d3.scale.linear().range([0,b.width]),this._xMap=function(a,b){return this._xScale(this._xValue(a,b))},this._xAxis=d3.svg.axis().scale(this._xScale).orient("bottom"),this._yValue=function(a){if("string"==typeof a[this._columns.y]){if(isNaN(Number(a[this._columns.y])))return this._yColumnType="string",void 0===a.index?(a.index=i,i):("string"==typeof a.index&&(a.index=Number(a.index)),a.index);this._yColumnType="number",a[this._columns.y]=Number(a[this._columns.y])}return a[this._columns.y]},this._yScale=d3.scale.linear().range([b.height,0]),this._yMap=function(a,b){return this._yScale(this._yValue(a,b))},this._yAxis=d3.svg.axis().scale(this._yScale).orient("left"),this._cValue=function(a){return a[this._columns.color]},this._svg=d3.select(this._container).append("svg").attr("width",b.width+c.left+c.right).attr("height",b.height+c.top+c.bottom).append("g").attr("transform","translate("+c.left+","+c.top+")").on("mousemove",function(){var b=d3.mouse(d3.select(this)[0][0]);a._svg.selectAll(a._container+"pt").attr("cx",b[0]).attr("cy",b[1]),a._mousemove.call(a)}),this._brush=d3.svg.brush().x(d3.scale.identity().domain([-5,b.width+5])).y(d3.scale.identity().domain([-5,b.height+5])).on("brush",this._brushed.bind(this))},d.renderChart=function(a){this._data=a,this._xScale.domain([d3.min(this._data,this._xValue.bind(this)),d3.max(this._data,this._xValue.bind(this))]),this._yScale.domain([d3.min(this._data,this._yValue.bind(this)),d3.max(this._data,this._yValue.bind(this))]),this._quadTree=d3.geom.quadtree().extent([[0,0],[b.width,b.height]]).x(this._xMap.bind(this)).y(this._yMap.bind(this))(this._data),this._xAxis.ticks(a.length),"string"===this._xColumnType&&this._xAxis.tickFormat(function(b){var c=a.map(function(a){return a[this._columns.x]}.bind(this));return c[b]}.bind(this)),this._svg.append("g").attr("class","x axis").attr("transform","translate(0,"+b.height+")").call(this._xAxis).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform",function(){return"rotate(-45)"}),"string"===this._yColumnType&&this._yAxis.tickFormat(function(b){var c=a.map(function(a){return a[this._columns.y]}.bind(this));return c[b]}.bind(this)),this._svg.append("g").attr("class","y axis").call(this._yAxis).append("text").attr("transform","rotate(-90)").attr("y",0-c.left).attr("x",0-b.height/2).attr("dy","1em").style("text-anchor","middle").text(this._columns.y),this._kdRect=this._svg.selectAll(".node").data(this.nodes(this._quadTree)).enter().append("rect").attr("class","node").attr("x",function(a){return a.x1}).attr("y",function(a){return a.y1}).attr("width",function(a){return a.x2-a.x1}).attr("height",function(a){return a.y2-a.y1}),this._point=this._svg.selectAll(".point").data(a).enter().append("circle").attr("class","point").attr("r",6).attr("cx",this._xMap.bind(this)).attr("cy",this._yMap.bind(this)),this._svg.append("circle").attr("id",this.config.container+"pt").attr("r",6).style("fill","none"),this._svg.append("g").attr("class","brush").call(this._brush)},d.nodes=function(a){var b=[];return a.depth=0,a.visit(function(a,c,d,e,f){a.x1=c,a.y1=d,a.x2=e,a.y2=f,b.push(a);for(var g=0;4>g;g++)a.nodes[g]&&(a.nodes[g].depth=a.depth+1)}),b},d.search=function(a,b,c,d,e){var f=[];return a.visit.call(this,function(a,g,h,i,j){var k=a.point;if(k){k.scanned=!0;var l=this._xScale(this._xValue(k),k.index),m=this._yScale(this._yValue(k),k.index);k.selected=l>=b&&d>l&&m>=c&&e>m,k.selected&&f.push(k[this._columns.key])}return g>=d||h>=e||b>i||c>j}.bind(this)),f},d._brushed=function(){var a=this._brush.extent();this._point.each(function(a){a.scanned=a.selected=!1});var b=this.search.call(this,this._quadTree,a[0][0],a[0][1],a[1][0],a[1][1]);this.select(),b&&this.interactions.onSelect.callback&&this.interactions.onSelect.callback.call(this,b)},d.nearest=function(a,b,c,d){var e=d.x1,f=d.y1,g=d.x2,h=d.y2;if(d.visited=!0,a<e-c.d||a>g+c.d||b<f-c.d||b>h+c.d)return c;var i=d.point;if(i){i.scanned=!0;var j=this._xScale(this._xValue(i),i.index)-a,k=this._yScale(this._yValue(i),i.index)-b,l=Math.sqrt(j*j+k*k);l<c.d&&(c.d=l,c.p=i)}var m=d.nodes,n=2*a>e+g,o=2*b>f+h;return m[2*o+n]&&(c=this.nearest.call(this,a,b,c,m[2*o+n])),m[2*o+(1-n)]&&(c=this.nearest.call(this,a,b,c,m[2*o+(1-n)])),m[2*(1-o)+n]&&(c=this.nearest.call(this,a,b,c,m[2*(1-o)+n])),m[2*(1-o)+(1-n)]&&(c=this.nearest.call(this,a,b,c,m[2*(1-o)+(1-n)])),c},d._mousemove=function(){pt=d3.selectAll(this._container+"pt");var a=+pt.attr("cx"),b=+pt.attr("cy");this._point.each(function(a){a.scanned=a.selected=!1}),this._kdRect.each(function(a){a.visited=!1});var c=this.nearest.call(this,a,b,{d:8,p:null},this._quadTree);c.p&&(c.p.selected=!0),this.probe(),this.interactions.onProbe.callback&&(c.p?this.interactions.onProbe.callback.call(this,c.p[this._columns.key]):this.interactions.onProbe.callback.call(this,null))},d.probe=function(a){a?(this._point.each(function(a){a.scanned=a.selected=!1}),this._data.map(function(b){b[this._columns.key]==a&&(b.selected=!0)}.bind(this))):null===a&&this._point.each(function(a){a.scanned=a.selected=!1}),this._point.classed("scanned",function(a){return a.scanned}),this._point.classed("selected",function(a){return a.selected})},d.select=function(a){a&&(this._point.each(function(a){a.scanned=a.selected=!1}),this._data.filter(function(b){for(var c=0;c<a.length;c++)b[this._columns.key]===a[c]&&(b.selected=!0)}.bind(this))),a&&0===a.length&&this._point.each(function(a){a.scanned=a.selected=!1}),this._point.classed("scanned",function(a){return a.scanned}),this._point.classed("selected",function(a){return a.selected})},d3Chart.Scatterplot=a}();
